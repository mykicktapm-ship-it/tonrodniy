# Текущий аудит безопасности TONRODY

Дата: 2024-06-10

## Область
Быстрый аудит backend-части (Express + Supabase) и связанных вебхуков на соответствие требованиям прозрачности и честности из `docs/tonrody_full_codex.md`.

## Основные выводы
1. **Нет аутентификации/авторизации для критических REST-операций**. Все роуты (`/lobbies`, `/rounds`, `/users`, `/ton`) монтируются без middleware, поэтому любой клиент может создавать лобби, занимать места, инициировать платежи или финализировать раунды, при этом сервер использует сервисный ключ Supabase с полными правами. 【F:backend/src/app.ts†L1-L32】【F:backend/src/db/supabase.ts†L99-L109】
2. **Платежи не проверяются на соответствие тарифу лобби**. Эндпоинт `POST /lobbies/:id/pay` принимает `txHash` и отмечает платеж как pending без сверки суммы; webhook `DepositReceived` помечает место как оплачено, записывая `amountTon` из события, но нигде не сравнивает его с ожидаемой ставкой `stake_amount`. Это позволяет недоплачивать или оплачивать неверные суммы без блокировки. 【F:backend/src/routes/lobbies.ts†L243-L305】【F:backend/src/routes/tonWebhookRoutes.ts†L437-L476】
3. **Финализация раунда выполняется оффчейн и доступна без контроля источника**. `POST /lobbies/:id/finalize` использует сохранённый `round_hash` и раскрытый сид из audit-лога для вычисления победителя и записи результатов, а затем отправляет транзакцию в TON. Нет проверки, что запрос пришёл с доверенного источника или что on-chain состояние совпадает с Supabase; достаточно HTTP-запроса, чтобы финализировать любой лобби. 【F:backend/src/routes/lobbies.ts†L310-L418】
4. **Вебхуки TON проверяют только общий секрет**. `/ton/events` принимает любой набор событий при совпадении заголовка `x-ton-webhook-secret`, без подписи тела или idempotency-трекера; повторная отправка или утечка секрета приводит к дублирующим/ложным выплатам и audit-логам. 【F:backend/src/routes/tonWebhookRoutes.ts†L548-L604】

## Рекомендации
- Ввести обязательную аутентификацию (service tokens / Telegram login / TON Connect подпись) и авторизационные правила для создания/финализации лобби и управления местами; ограничить использование сервисного ключа Supabase из публичных запросов.
- Принимать платежи только после on-chain валидации суммы: сверять `amountTon` с `stake_amount`, блокировать расхождения и логировать попытки.
- Ограничить финализацию раунда доверенным актором (например, подписанным backend-джобом), синхронизировать с состоянием смарт-контракта и фиксировать повторные вызовы через idempotency ключи.
- Для вебхуков добавить HMAC-подпись тела + повторную защиту (eventId/txHash idempotency), а также явный allowlist источников.
